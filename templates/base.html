<!DOCTYPE HTML>
<html lang="en">

<head>
	<title>{% if version == 'local' %}Local{% elif version == 'online' %}Online{% else %}Single Player{% endif %} Game</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
	<link rel='stylesheet' type='text/css' href='/static/style.css'>
</head>

<body>
	<div class="container">
		<div class="row">
			<h1 class="display-4">
				{% if version=='single' %}Single Player{% elif version == 'online' %}Online Two Player{% else %}Local Two Player{% endif %}
			</h1>
		</div>
		<div class="row{% if version == 'online' %} hidden{% endif %}">
			<p class='lead'>
				{% if version == 'single' %}Single Player game against an AI
				{% elif version == 'online'%}Two player draughts game against someone online
				{% else %}Two Player game against someone of the same device
				{% endif %}
			</p>
		</div>
		<div class='row{% if version == 'online' %} hidden{% endif %}'>
			<canvas width=800 height=800 id='game_board' class='border border-dark rounded'></canvas>
		</div>
		{% if version == 'online' %}
			<div id='findGame'>
				<div class='row'>
					<p class='lead'>Create a game or join someone else's:</p>
				</div>
				<div class='row'>
					<div class="input-group">
						<span class="input-group-append">
							<button class='btn btn-secondary rounded-left' id='createGame'>Create game</button>
						</span>
						<input type="text" class="form-control" id='nameInput' placeholder='Game name'>
					</div>
				</div>
				<div class="row">
					<table>
						<th>Games to join:</th>
					</table>
				</div>
			</div>
		{% endif %}
	</div>
</body>
<script type='text/javascript'>
	$(document).ready(function () {
		var version = "{{version}}";
		if (version == 'online'){
			var socket = io.connect('/online')
		}
		else {
			var socket = io.connect();
		}
		var board = ['white man', 'white man', 'white man', 'white man', 'white man', 'white man', 'white man', 'white man', 'white man', 'white man', 'white man', 'white man', null, null, null, null, null, null, null, null, 'black man', 'black man', 'black man', 'black man', 'black man', 'black man', 'black man', 'black man', 'black man', 'black man', 'black man', 'black man'];
		var selected = null;
		var moves = [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], []];
		var canvas = $('#game_board')[0];
		canvas.addEventListener('click', function (event) { clicked(event) });
		var context = canvas.getContext('2d');
		var color = null;
		var started = false;
		function drawBoard() {
			var space = 0;
			// Draw board base
			for (var y = 0; y < 8; y++) {
				for (var x = 0; x < 8; x++) {
					if (x % 2 != y % 2) {
						context.fillStyle = 'white';
					}
					else {
						context.fillStyle = 'darkgrey';
					}
					context.fillRect(x * 100, y * 100, 100, 100);
				}
			};
			for (var y = 0; y < 8; y++) {
				for (var x = 0; x < 8; x++) {
					if (x % 2 == y % 2) {
						if (selected === null) {
							if (moves[space].length > 0) {
								context.strokeStyle = '#007BFF';
								context.lineWidth = 3;
								//This piece can be moved
								context.strokeRect(x * 100, y * 100, 100, 100);
								context.lineWidth = 1;
							}
						}
						else {
							if (space == selected) {
								context.strokeStyle = '#007BFF';
								context.lineWidth = 3;
								context.strokeRect(x * 100, y * 100, 100, 100);
								context.lineWidth = 1;

							}
							else if (moves[selected].indexOf(space) >= 0) {
								// piece can move to here
								context.fillStyle = '#007BFF';
								context.fillRect(x * 100, y * 100, 100, 100);
							}
						}
						if (board[space] != null) {
							context.strokeStyle = 'black';
							if (board[space].split(' ')[0] == 'white') {
								context.fillStyle = 'white';
							}
							else {
								context.fillStyle = 'black';
							}
							context.beginPath();
							context.arc(x * 100 + 50, y * 100 + 50, 45, 0, 2 * Math.PI);
							context.fill();
							context.stroke();
							if (board[space].split(' ')[1] == 'king') {
								context.font = "50px Times New Roman";
								if (board[space].split(' ')[0] == 'black') {
									context.fillStyle = 'white';
								}
								else {
									context.fillStyle = 'black';
								}
								context.textAlign = 'center';
								context.textBaseline = 'middle';
								context.fillText('K', x * 100 + 50, y * 100 + 50);
							}
						}
						space++;
					}
				}
			}
		}
		function clicked(event) {
			var x = event.pageX - canvas.offsetLeft;
			var y = event.pageY - canvas.offsetTop;
			var pos = Math.floor(Math.floor(x / canvas.scrollWidth * 8) / 2) + Math.floor(y / canvas.scrollHeight * 8) * 4
			if (selected === null) {
				if (board[pos] != null) {
					console.log('selected: ' + pos)
					selected = pos;
					drawBoard();
				}

			}
			else {
				console.log('Making move from ' + selected + ' to ' + pos);
				socket.emit('move request', { current_pos: selected, new_pos: pos });
				selected = null;
			}

		}
		socket.on('game end', function (data) {
			var message;
			if (data.result == 'black') {
				message = 'Black Wins!';
			}
			else if (data.result == 'white') {
				message = 'White Wins!';
			}
			else {
				message = 'It\'s a draw';
			}
			var display_message = '<div class="alert alert-success alert-dismissible fade show"><button type="button" class="close" data-dismiss="alert">&times;</button>' + message + '</div>';
			$('#info').append(display_message);
		});
		socket.on('move data', function (data) {
			moves = data.moves;
			drawBoard();
		});
		socket.on('move response', function (data, from, to) {
			if (data.result === true) {
				board = data.board;
				moves = data.moves;
			}
			drawBoard();
		});
		socket.on('start game', function (data) {
        $('#findGame').toggleClass('hidden');
        $('.lead').toggleClass('hidden');
        $('#board_row').toggleClass('hidden');
        started = true
        moves = data.moves;
        if (data.black == id) {
            color = 'black';
        }
        else {
            color = 'white';
        }
        drawBoard();
    });
		socket.on('room close', function (room) {
        $('button#' + room).parent().parent().remove();
    });
		socket.on('add room', function (room) {

			console.log('New room ' + room.name);
			var element;
			if (room.creator == id) {
				element = $('<button/>', {
					text: 'Cancel',
					class: 'btn btn-primary',
					id: room.name,
					click: function () { socket.emit('cancel game', this.id) }
				});
			}
			else {
				element = $('<button/>', {
					text: 'Join ',
					class: "btn btn-primary",
					id: room.name,
					click: function () { socket.emit('join room', this.id) }
				});
			}
			$('table').append(
				$('<tr></tr>').append(
					$('<td></td>').text(room.name), $('<td></td').append(element)
				)
			)
		});
		function startUp(){
			if (version == 'online'){
				var rooms = {{ rooms| safe }};
				var id = {{ id }};
				for (var i = 0; i < rooms.length; i++) {
					$("table").append(
						$('<tr></tr>').append(
							$('<td></td>').text(rooms[i]), $('<td></td').append(
								$('<button/>', {
									text: 'Join ',
									class: "btn btn-primary",
									id: rooms[i],
									click: function () { socket.emit('join room', this.id) }
								}
								)
							)
						)
					);
				}
				$(document).on('click', '#createGame', function () { socket.emit('create room', $('#nameInput').val()) });
			}
			else {
				socket.on('connect', function () {
					socket.emit('request move data');
				});
				drawBoard();
			}
		};
		startUp();
	})
</script> 

</html>
