<!DOCTYPE HTML>
<html lang="en">
<!--
	Use modal for end message
	make messages scroll
	increase message input box when a long message is typed
	add animations to board
	add indicators to message sender
	add badges for messages
	add navbar
	carousel with game play
	progress bar for single player
-->
<head>
	<title>{% if version == 'local' %}Local{% elif version == 'online' %}Online{% else %}Single Player{% endif %} Game</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
	<link rel='stylesheet' type='text/css' href='/static/style.css'>
</head>

<body>
	<div class="container">
		<div class="row">
			<h1 class="display-4">
				{% if version=='single' %}Single Player{% elif version == 'online' %}Online Two Player{% else %}Local Two Player{% endif %}
			</h1>
		</div>
		<div class="row">
			<p class="lead{% if version == 'online' %} hidden{% endif %}">
				{% if version == 'single' %}Single Player game against an AI
				{% elif version == 'online'%}Two player draughts game against someone online
				{% else %}Two Player game against someone of the same device
				{% endif %}
			</p>
		</div>
		<div class="row{% if version == 'online' %} hidden{% endif %}" id='board_row'>
			<canvas width=800 height=800 id='game_board' class='border border-dark rounded'></canvas>
			{% if version == 'online' %}
				<div id='chat' class='card card-info border-info'>
					<div class="card-header">
						<h4 class='card-title'>Chat</h4>
					</div>
					<div class="card-body pre-scrollable" id='messages-text'>
						<h5 class='card-subtitle text-muted'>Talk to your opponent:<br/></h5>
						<ul class="list-group list-group-flush" id='chatList'></ul>
					</div>
					<div class="card-footer">
						<div class="input-group">
							<input type="text" class="form-control" id='messageInput' placeholder='Message'>
							<span class="input-group-append">
								<button class='btn btn-info rounded-right' id='sendMessage'>Send</button>
							</span>
						</div>
					</div>
				</div>
			{% endif %}
		</div>
		{% if version == 'online' %}
			<div id='findGame'>
				<div class='row'>
					<p class='lead'>Create a game or join someone else's:</p>
				</div>
				<div class='row'>
					<div class="input-group">
						<span class="input-group-append">
							<button class='btn btn-secondary rounded-left' id='createGame'>Create game</button>
						</span>
						<input type="text" class="form-control" id='nameInput' placeholder='Game name'>
					</div>
				</div>
				<div class="row">
					<table>
						<th>Games to join:</th>
					</table>
				</div>
			</div>
		{% endif %}
	</div>
</body>
<script type='text/javascript' charset="utf-8">
	$(document).ready(function () {
		var version = "{{version}}";
		if (version == 'online'){
			var socket = io.connect('https://' + document.domain + ':' + location.port+'/online');
			var rooms = {{ rooms| safe }};
			var id = {{ id }};
		}
		else {
			var socket = io.connect('https://' + document.domain + ':' + location.port);
		}
		var board = ['white man', 'white man', 'white man', 'white man', 'white man', 'white man', 'white man', 'white man', 'white man', 'white man', 'white man', 'white man', null, null, null, null, null, null, null, null, 'black man', 'black man', 'black man', 'black man', 'black man', 'black man', 'black man', 'black man', 'black man', 'black man', 'black man', 'black man'];
		var selected = null;
		var moves = [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], []];
		var canvas = $('#game_board')[0];
		var context = canvas.getContext('2d');
		if (version == 'single'){
			var color = 'black';
		}
		else {
			var color = null;
		}
		var started = false;
		function playAgain(){
			console.log('play again');
		}
		function drawBoard(event) {
			var space = 0;
			// Draw board base
			for (var y = 0; y < 8; y++) {
				for (var x = 0; x < 8; x++) {
					if (x % 2 != y % 2) {
						context.fillStyle = 'white';
					}
					else {
						context.fillStyle = 'darkgrey';
					}
					context.fillRect(x * 100, y * 100, 100, 100);
				}
			};
			for (var y = 0; y < 8; y++) {
				for (var x = 0; x < 8; x++) {
					if (x % 2 == y % 2) {
						if (selected === null) {
							if (moves[space].length > 0) {
								if (version == 'local' || board[space].split(' ')[0] == color){
									context.strokeStyle = '#007BFF';
								}
								else {
									context.strokeStyle = 'red';
								}
								context.lineWidth = 3;
								context.strokeRect(x * 100, y * 100, 100, 100);
								context.lineWidth = 1;
							}
						}
						else {
							if (moves[selected].indexOf(space) >= 0) {
								// piece can move to here
								context.fillStyle = '#007BFF';
								context.fillRect(x * 100, y * 100, 100, 100);
							}
						}
						if (board[space] != null) {
							context.strokeStyle = 'black';
							if (board[space].split(' ')[0] == 'white') {
								context.fillStyle = 'white';
							}
							else {
								context.fillStyle = 'black';
							}
							context.beginPath();
							if ( space != selected) {
								context.arc(x * 100 + 50, y * 100 + 50, 45, 0, 2 * Math.PI);
								context.fill();
								context.stroke();
								if (board[space].split(' ')[1] == 'king') {
									context.font = "50px Times New Roman";
									if (board[space].split(' ')[0] == 'black') {
										context.fillStyle = 'white';
									}
									else {
										context.fillStyle = 'black';
									}
									context.textAlign = 'center';
									context.textBaseline = 'middle';
									context.fillText('K', x * 100 + 50, y * 100 + 50);
								}
							}
							
						}
						space++;
					}
				}
			}
			if (event){
				context.strokeStyle = 'black';
				if (board[selected].split(' ')[0] == 'white') {
					context.fillStyle = 'white';
				}
				else {
					context.fillStyle = 'black';
				}
				context.beginPath();
				if (version == 'online' && color == 'white'){
					var _x = Math.round((canvas.scrollWidth - (event.pageX - canvas.offsetLeft))/canvas.scrollWidth*800);
					var _y = Math.round((canvas.scrollHeight - (event.pageY - canvas.offsetTop))/canvas.scrollHeight*800);
				}
				else {
					var _x = Math.round((event.pageX - canvas.offsetLeft)/canvas.scrollWidth*800);
					var _y = Math.round((event.pageY - canvas.offsetTop)/canvas.scrollHeight*800);
				}
				context.arc(_x, _y, 55, 0, 2 * Math.PI);
				context.fill();
				context.stroke();
				if (board[selected].split(' ')[1] == 'king') {
					context.font = "50px Times New Roman";
					if (board[selected].split(' ')[0] == 'black') {
						context.fillStyle = 'white';
					}
					else {
						context.fillStyle = 'black';
					}
					context.textAlign = 'center';
					context.textBaseline = 'middle';
					context.fillText('K', _x, _y);
				}
			}
		}
		function mouseDown(event){
			if (version == 'online' && color == 'white'){
				var x = canvas.scrollWidth - (event.pageX - canvas.offsetLeft);
				var y = canvas.scrollHeight - (event.pageY - canvas.offsetTop);
			}
			else {
				var x = event.pageX - canvas.offsetLeft;
				var y = event.pageY - canvas.offsetTop;
			}
			
			var pos = Math.floor(x / canvas.scrollWidth * 8) + Math.floor(y / canvas.scrollHeight * 8) * 8
			if (pos % 2 ==  Math.floor(y / canvas.scrollHeight * 8) % 2) {
				pos = Math.floor(pos / 2);
				if (board[pos] != null && moves[pos].length > 0 && (version == 'local' || board[pos].split(' ')[0] == color)) {
					selected = pos;
				}
			}
		};
		function mouseUp(event){
			if (version == 'online' && color == 'white'){
				var x = canvas.scrollWidth - (event.pageX - canvas.offsetLeft);
				var y = canvas.scrollHeight - (event.pageY - canvas.offsetTop);
			}
			else {
				var x = event.pageX - canvas.offsetLeft;
				var y = event.pageY - canvas.offsetTop;
			}
			var pos = Math.floor(x / canvas.scrollWidth * 8) + Math.floor(y / canvas.scrollHeight * 8) * 8
			if (pos % 2 ==  Math.floor(y / canvas.scrollHeight * 8) % 2) {
				pos = Math.floor(pos / 2);
				socket.emit('move_request', { current_pos: selected, new_pos: pos });
				selected = null;
			}
			else{
				selected = null;
				drawBoard();
			}

		};
		socket.on('game_end', function (data) {
			var message;
			if (data.result == 'black') {
				message = 'Black Wins!';
			}
			else if (data.result == 'white') {
				message = 'White Wins!';
			}
			else {
				message = 'It\'s a draw';
			}
			if (version == 'local' || data.result == color){
				var extraInfo = "Well done "+data.result+"! You won.\nYou can play again or return to the main menu:";
			}
			else if (data.result == 'draw'){
				var extraInfo = 'Well played - is a draw!\nYou can play again or return to the main menu:';
			}
			else{
				var extraInfo = 'Unlucky, you lost this game :(\nYou can play again or return to the main menu:'
			}
			$('body').prepend(
				$('<div/>', {class: 'alert alert-primary alert-dismissible fade show alert-end', role: "alert"}).append(
					$('<button />', {type: 'button', class: 'close', "data-dismiss": 'alert'}).append('<span aria-hidden="true">&times;</span>'),
					$('<p/>').text(message),
					$('<hr>'),
					$('<p/>').text(extraInfo),
					$('<div />', {class: 'btn-group'}).append(
						$('<a />', {type: 'button', class: 'btn btn-primary', text: "Home", href: "{{ url_for('index') }}"}),
						$('<button />', {type: 'button', class: 'btn btn-primary', disabled: true, text: "Play again", click: function () { playAgain(); }})
						
					)
					

				)
			);
			
			

		});
		socket.on('move_data', function (data) {
			moves = data.moves;
			drawBoard();
		});
		socket.on('move_response', function (data, from, to) {
			console.log('response ');
			console.log(data.result);
			if (data.result === true) {
				board = data.board;
				moves = data.moves;
			}
			drawBoard();
		});
		socket.on('start_game', function (data) {
			$(document).on('click', '#sendMessage', function () {
				console.log('message send');
				socket.emit('message', $('#messageInput').val())
				$('#chatList').append(
					$('<li/>', {
						class: 'list-group-item your-message',
						text: $('#messageInput').val()
					})
				);
				$('#messageInput').val('');
				 
			});
			$('#findGame').toggleClass('hidden');
			$('.lead').toggleClass('hidden');
			$('#board_row').toggleClass('hidden');
			started = true
			moves = data.moves;
			if (data.black == id) {
			    color = 'black';
			}
			else {
			    color = 'white';
				context.translate(canvas.width, canvas.height);
				context.rotate(Math.PI);
			}
			drawBoard();
		});
		socket.on('room_close', function (room) {
        $('button[id="'+room+'"]').parent().parent().remove();
    });
		socket.on('add_room', function (room) {
			var element;
			if (room.creator == id) {
				element = $('<button/>', {
					text: 'Cancel',
					class: 'btn btn-primary',
					id: room.name,
					click: function () { socket.emit('cancel_game', this.id) }
				});
			}
			else {
				element = $('<button/>', {
					text: 'Join ',
					class: "btn btn-primary",
					id: room.name,
					click: function () { socket.emit('join_game', this.id) }
				});
			}
			$('table').append(
				$('<tr></tr>').append(
					$('<td></td>').text(room.name), $('<td></td').append(element)
				)
			)
		});
		socket.on('message', function(message){
			console.log('message recieved');
			$('#chatList').append(
				$('<li/>', {
					class: 'list-group-item other-message',
					text: message
				})
			)
		});
		function startUp(){
			if (version == 'online'){
				for (var i = 0; i < rooms.length; i++) {
					$("table").append(
						$('<tr></tr>').append(
							$('<td></td>').text(rooms[i]), $('<td></td').append(
								$('<button/>', {
									text: 'Join ',
									class: "btn btn-primary",
									id: rooms[i],
									click: function () { socket.emit('join_game', this.id) }
								}
								)
							)
						)
					);
				}
				$(document).on('click', '#createGame', function () { socket.emit('create_game', $('#nameInput').val()) });
			}
			else {
				socket.on('connect', function () {
					socket.emit('request_move_data');
				});
				drawBoard();
			}
		};
		canvas.addEventListener('mousedown', function (event) { mouseDown(event) });
		canvas.addEventListener('mouseup', function(event){ mouseUp(event)});
		canvas.addEventListener('mousemove', function(event){ if(selected != null){ drawBoard(event) }});
		startUp();
	})
</script> 

</html>
